---
title: "JHU COVID-19 Data by State and National"
author: "Jonah Pool"
date: "7/17/2021"
output:
  word_document: default
  pdf_document: default
  html_document: default
update: 7/17/2021
---

```{r setup, include=FALSE}
library(tidyverse)
library(magrittr)
library(ggplot2)
library(plotly)
library(ggpubr)
library(flextable)
library(lubridate)
library(DescTools)
library(effsize)
library(pwr)
library(lmerTest)
library(sjPlot)
library(webshot)
library(scales)
# library(shiny)
library(maps)
library(plotly)
library(kableExtra)
library(knitr)

library(zoo)
library(fpp2)
library(forecast)

library(sf)
library(tmap)
library(cartography)
library(treemap)

library(usmap)
library(ggspatial)
library(rnaturalearth)
library(rnaturalearthdata)
```

By State Snapshot Today
```{r eval=F}
csse_today_states <- csse_today %>% 
  inner_join(uid_states, key = "UID") %>% 
  filter(Province_State %in% us_uid$Province_State & !(is.na(Province_State)), !(Province_State %in% c("Diamond Princess", "Recovered", "Grand Princess"))) %>%
  rename(state = Province_State) %>% 
  rename(confirmed = Confirmed, deaths = Deaths, recovered = Recovered, active = Active, tested = Total_Test_Results, hospitalized = People_Hospitalized) %>% 
  arrange(desc(Testing_Rate))


daily_updates_ts %<>% 
  inner_join(uid_states, key = "UID") %>% 
  #filter(Province_State %in% us_uid$Province_State & !(is.na(Province_State)), !(Province_State %in% c("Diamond Princess", "Recovered", "Grand Princess"))) %>%
  rename(state = Province_State) %>% 
  rename(date = Date, confirmed = Confirmed, deaths = Deaths, recovered = Recovered, active = Active, tested = People_Tested, hospitalized = People_Hospitalized) %>% 
  filter(!(is.na(Testing_Rate))) %>% 
  arrange(date)

```


Testing and Incident Rate
```{r eval=F}
csse_today_states %<>% 
  mutate(c_d_rat = deaths / confirmed) %>% 
  filter(!(is.na(c_d_rat))) %>% 
  filter(c_d_rat != Inf)
```

```{r eval=F}
#"1M", "2M", "3M", "4M", "5M", "6M", "7M", "8M", "9M", "10M", "11M", "12M"
md_testing_rate <- csse_today_states$Testing_Rate[csse_today_states$state == "Maryland"]
md_testing_rate
mean_testing_rate <- mean(csse_today_states$Testing_Rate)
mean_testing_rate
```
```{r eval=F}
csse_today_states_sorted <- csse_today_states %>% mutate(vote = case_when(
  state %in% blue_states ~ "Dem",
  state %in% red_states ~ "Rep"
)) %>% 
  mutate(vote = factor(vote)) %>% mutate(vote = fct_relevel(vote, c("Rep", "Dem")))
head(daily_updates_ts)

in_millions <- function(x) (x / 1000000)
states_sorted_in_millions <- csse_today_states_sorted %>% mutate_at(vars(matches("Population")), in_millions) %>% pull(Population) %>% summary()
N <- 20
pop_breaks <- c(-Inf, 500000, seq(10^6,N*10^6, by = 2*10^6), Inf)
pop_break_levels <- c("<500K", "500K", paste(seq(2,N-2,by=2), rep("M",times = round(((N/2)-1), 1), sep="")), paste(c(">", as.character(N), "M"),collapse=""))
head(pop_break_levels)

csse_today_states_sorted %<>% mutate(Pop_fac = cut(csse_today_states_sorted$Population, breaks = pop_breaks, labels = pop_break_levels))
csse_today_states_sorted %<>% filter(Testing_Rate < 75000)# %>% filter(Mortality_Rate < 6)

daily_updates_ts %<>% mutate(Pop_fac = cut(daily_updates_ts$Population, breaks = pop_breaks, labels = pop_break_levels))
daily_updates_ts %<>% filter(Testing_Rate < 75000)

mean_testing_rates <- csse_today_states_sorted %>% 
  group_by(vote) %>% 
  summarize(sum = sum(Population), avg = mean(Population), median = median(Population))
head(mean_testing_rates)

daily_updates_ts_sorted <- daily_updates_ts %>% mutate(vote = case_when(
  state %in% blue_states ~ "Dem",
  state %in% red_states ~ "Rep"
)) %>% 
  mutate(vote = factor(vote)) %>% mutate(vote = fct_relevel(vote, c("Rep", "Dem")))
head(daily_updates_ts_sorted)

daily_updates_ts_sum <- daily_updates_ts_sorted %>%  
  group_by(state,vote) %>% 
  summarise(mean_testing_rate = mean(Testing_Rate), med_testing_rate = median(Testing_Rate))
```


Cases Time Series
```{r}
cases_ts <- csse_confirmed_us_ts %>%
  # select(-Lat, -Long_, -FIPS) %>%
  filter(Province_State %in% us_uid$Province_State) %>%
  filter(!(is.na(Admin2))) %>% 
  filter(!(Province_State %in% c("Diamond Princess", "Recovered", "Grand Princess"))) %>%
  group_by(UID) %>%
  pivot_longer(`1/22/20`:last_col(), names_to = "date", values_to = "cases") %>%
  #gather(`1/22/20`:last_col(), key = "date", value = "cases") %>% 
  ungroup()
# cases_ts  
cases_ts_states <- cases_ts %>%
  select(-Admin2) %>% 
  group_by(date, Province_State) %>%
  summarize(cases = sum(cases)) %>% 
  left_join(uid_states, key = "Province_State") %>%
  ungroup()

cases_ts_states %<>% 
  group_by(Province_State) %>%
  mutate(date = mdy(date)) %>%
  arrange(date) %>%
  mutate(cases_per_hundred_thousand = round((cases / Population * 100000), 1), cases_delta = cases - lag(cases), cases_relative = cases_delta / lag(cases))
cases_ts_states %<>%
  mutate(cases_delta = case_when(
    is.na(cases_delta) ~ as.double(cases),
    TRUE ~ as.double(cases) - as.double(lag(cases))
  ), cases_delta_per_hundred_thousand = round((100000 * cases_delta / Population), 1), cases_delta_ma = movingAverage(cases_delta), cases_delta_ma_per_hundred_thousand = movingAverage(cases_delta_per_hundred_thousand),
  cases_relative = case_when(
    is.na(cases_relative) ~ 0,
    cases_relative == Inf ~ 1,
    TRUE ~ cases_delta / lag(cases)), cases_perc = round(100*cases_relative, 3)) %>%
  ungroup() %>% 
  filter(!(date %in% exclude)) %>%
  mutate(state = factor(Province_State)) %>% 
  select(UID, date, state, Combined_Key, Population, cases, cases_per_hundred_thousand, cases_delta, cases_delta_per_hundred_thousand, cases_relative, cases_perc, cases_delta_ma, cases_delta_ma_per_hundred_thousand) %>% 
  mutate(vote = case_when(
  state %in% blue_states ~ "Dem",
  state %in% red_states ~ "Rep")) %>% 
  mutate(vote = factor(vote)) %>% 
  mutate(vote = fct_relevel(vote, c("Rep", "Dem")))
saveRDS(cases_ts_states, "cases_state.rds")
```

Deaths Time Series
```{r}
deaths_ts <- csse_deaths_us_ts %>%
  select(-Lat, -Long_, -FIPS) %>%
  #filter(Province_State %in% states)# %>% 
  filter(!(is.na(Admin2))) %>% 
  filter(!(Province_State %in% c("Diamond Princess", "Recovered", "Grand Princess"))) %>%
  group_by(UID) %>%
  pivot_longer(`1/22/20`:last_col(), names_to = "date", values_to = "deaths") %>%
  ungroup()
deaths_ts_states <- deaths_ts %>%
  select(-Admin2) %>% 
  group_by(Province_State, date) %>% 
  summarize(deaths = sum(deaths)) %>%
  inner_join(uid_states, key = "Province_State") %>%
  ungroup() %>% 
  group_by(Province_State) %>%
  mutate(date = mdy(date)) %>%
  arrange(date) %>%
  mutate(deaths_per_hundred_thousand = round((100000 * deaths / Population), 2), deaths_delta = deaths - lag(deaths), deaths_relative = deaths_delta / lag(deaths))
deaths_ts_states %<>%
  mutate(deaths_delta = case_when(
    is.na(deaths_delta) ~ as.double(deaths),
    TRUE ~ as.double(deaths) - as.double(lag(deaths))
  ), deaths_delta_per_hundred_thousand = round((100000 * deaths_delta / Population), 2), deaths_delta_ma = movingAverage(deaths_delta), deaths_delta_ma_per_hundred_thousand = movingAverage(deaths_delta_per_hundred_thousand),
  deaths_relative = case_when(
    is.na(deaths_relative) ~ 0,
    deaths_relative == Inf ~ 1,
    TRUE ~ deaths_delta / lag(deaths)), deaths_perc = round((100 * deaths_relative), 3), deaths_perc_ma = movingAverage(deaths_perc)) %>%
  ungroup() %>% 
  filter(!(date %in% exclude)) %>% 
  mutate(state = factor(Province_State)) %>% 
  mutate(vote = case_when(
  state %in% blue_states ~ "Dem",
  state %in% red_states ~ "Rep")) %>% 
  mutate(vote = factor(vote)) %>% 
  mutate(vote = fct_relevel(vote, c("Rep", "Dem")))
#deaths_ts_states <- deaths_ts_states %>% 
#  filter(!(is.na(state)), state %in% uid_states$Province_State)
saveRDS(deaths_ts_states, "deaths_state.rds")
#deaths_ts_states
```

Combined Tables
```{r message=FALSE}
combined_ts_states <- cases_ts_states %>% 
  full_join(deaths_ts_states) %>% 
  mutate(vote = case_when(
  state %in% blue_states ~ "Dem",
  state %in% red_states ~ "Rep")) %>% 
  mutate(vote = factor(vote)) %>% 
  mutate(vote = fct_relevel(vote, c("Rep", "Dem")))
#combined_ts_mil <- cases_ts_mil %>% 
#  full_join(deaths_ts_mil)
```

Top 5 states by cases
```{r}
top5cases_today <- cases_ts_states %>%
  filter(date == day) %>%
  top_n(5, cases_delta)

top5cases_today_pht <- cases_ts_states %>% 
  filter(date == day) %>% 
  top_n(5, cases_per_hundred_thousand)

top5deaths_today<- deaths_ts_states %>%
  filter(date == day) %>% 
  top_n(5, deaths_delta)

top5deaths_today_pht <- deaths_ts_states %>%
  filter(date == day) %>% 
  top_n(5, deaths_per_hundred_thousand)

priority_states <- c("Maryland", "Texas", "Virginia", "California", "Georgia", "Florida")

priority_cases_today <- cases_ts_states %>% 
  filter(date == day & (state %in% top5cases_today$state | state %in% priority_states)) %>% 
  mutate(state = fct_reorder(state, cases_delta))
# priority_cases_today

priority_cases_today_pht <- cases_ts_states %>% 
  filter(date == day & (state %in% top5cases_today_pht$state | state %in% priority_states)) %>% 
  mutate(state = fct_reorder(state, cases_per_hundred_thousand))

priority_deaths_today <- deaths_ts_states %>% 
  filter(date == day & (state %in% top5deaths_today$state | state %in% priority_states)) %>% 
  mutate(state = fct_reorder(state, deaths_delta))

priority_deaths_today_pht <- deaths_ts_states %>% 
  filter(date == day & (state %in% top5deaths_today_pht$state | state %in% priority_states)) %>% 
  mutate(state = fct_reorder(state, deaths_per_hundred_thousand))
# priority_deaths_today_pht


priority_ts <- combined_ts_states %>% 
  filter(state %in% top5cases_today$state | state %in% priority_states)
priority_ts_last30 <- priority_ts %>%
  filter(date %in% sinceMarch16)



```

New Cases Today in Priority States
```{r}
minor_values <- seq(as.integer(500), as.integer(round(max(priority_cases_today$cases_delta),-3)), by = as.integer(500))
p1 <- ggplot(priority_cases_today, aes(x = state, y = cases_delta, fill = vote)) +
  geom_col() +
  #scale_fill_manual(values = rep(blue.fill.10,3)) +
  labs(y = "", title = "New Cases", x = "")+
  theme(legend.position = "none",
        panel.grid.major.x=element_line(color="dark grey", size=0.2),
        panel.grid.minor.x=element_line(color="dark grey", size=0.2),
        axis.ticks=element_line(color="white"))+
  coord_flip() +
  #scale_y_discrete(breaks=as.character(c("2", "4", "5")))+#breaks=c(2000, 4000, 6000))+
  pq+jhu_caption
p1

```

New Cases Per 100,000 in Priority States
```{r}
p3 <- ggplot(priority_cases_today_pht, aes(x = state, y = cases_per_hundred_thousand, fill = vote)) +
  geom_col() +
  #scale_fill_manual(values = rep(blue.fill.10,3)) +
  labs(y = "", title = "Cumulative Cases (Per 100,000 People)", x = "") +
  theme(legend.position = "none",
        panel.grid.major.x=element_line(color="dark grey", size=0.2),
        panel.grid.minor.x=element_line(color="dark grey", size=0.2),
        axis.ticks=element_line(color="white")) +
  coord_flip()+
  pq+jhu_caption
p3
```

Deaths Today in Priority States
```{r}
p2 <- ggplot(priority_deaths_today, aes(x = state, y = deaths_delta, fill = vote)) +
  geom_col()+
  #scale_fill_manual(values = c(red.fill.10,red.fill.10)) +
  labs(y = "", title = "Deaths Today", x = "") +
  theme(legend.position = "none",
        panel.grid.major.x=element_line(color="dark grey", size=0.2),
        panel.grid.minor.x=element_line(color="dark grey", size=0.2),
        axis.ticks=element_line(color="white")) +
  coord_flip() +
  pq+jhu_caption
p2
```

Cumulative Deaths in Priority States
```{r}
p4 <- ggplot(priority_deaths_today_pht, aes(x = state, y = deaths_per_hundred_thousand, fill = vote)) + 
  geom_col() + 
  #scale_fill_manual(values = c(red.fill.10, red.fill.5)) + 
  labs(y = "", title = "Cumulative Deaths Per Hundred Thousand People", x = "") + 
  theme(legend.position = "none",
        panel.grid.major.x=element_line(color="dark grey", size=0.2),
        panel.grid.minor.x=element_line(color="dark grey", size=0.2),
        axis.ticks=element_line(color="white")) + 
  coord_flip() + 
  pq+jhu_caption
p4
```

```{r}
top3_states <- deaths_ts_states %>% 
  filter(date == day) %>% 
  top_n(3, deaths)
# top3_states$state
top3_sum <- top3_states %>% 
  summarize(deaths = sum(deaths), state = "Top 3")
rest <- deaths_ts_states %>% 
  filter(!(state %in% top3_states$state)) %>%
  filter(date == day) %>% 
  summarize(deaths = sum(deaths), state = "Other")

compare <- full_join(rest, top3_sum)
# compare
top3_sum$deaths/(rest$deaths + top3_sum$deaths)

p7 <- ggplot(compare, aes(x=state, y=deaths, fill = c("blue", "orange")))+
  geom_col() + 
  scale_fill_manual(values = c("blue", "orange")) + 
  labs(y = "", title = "Cumulative Deaths", x = "") + 
  theme(legend.position = "none") + 
  pq+jhu_caption
p7

red_states_ts <- combined_ts_states %>% 
  filter(date == day) %>% 
  filter(state %in% red_states) %>% 
  mutate(vote = "Rep")

blue_states_ts <- combined_ts_states %>% 
  filter(date == day) %>% 
  filter(state %in% blue_states) %>% 
  mutate(vote = "Dem")

red_v_blue <- full_join(red_states_ts, blue_states_ts)
red_v_blue %<>% mutate(vote = factor(vote)) %>% mutate(vote = fct_rev(vote))
# red_v_blue

red_v_blue_sum <- red_v_blue %>% 
  group_by(vote) %>% 
  summarise(average_death_rate = mean(deaths_per_hundred_thousand), average_case_rate=mean(cases_per_hundred_thousand), stdev=sd(cases_per_hundred_thousand))
# red_v_blue_sum
```
```{r}
p8 <- ggplot(red_v_blue, aes(x=deaths_per_hundred_thousand, fill = vote))+
  geom_density(alpha = 0.7)+
  #geom_segment(x=filter(red_v_blue_sum, vote=="Dem")$average_death_rate, xend=filter(red_v_blue_sum, vote=="Rep")$average_death_rate, y=0.0127, yend=0.013)+
  theme_538()
  #scale_fill_manual(values = c("blue", "red"))+
  #labs(x="Governor Party Affiliation", y="Death Rate")
p8
```

```{r}
#data.frame(a=seq(1,50000, by=1),b=rnorm(500000, mean=2500, sd=1000))
p9 <- ggplot(red_v_blue, aes(x=cases_per_hundred_thousand, fill = vote))+
  geom_density(alpha=0.7)+
  geom_density(data=data.frame(a=seq(1,500000, by=1),b=rnorm(500000, mean=mean(max(red_v_blue_sum$average_case_rate),min(red_v_blue_sum$average_case_rate)), sd=mean(max(red_v_blue_sum$stdev),min(red_v_blue_sum$stdev)))), aes(x=b, fill="Normal"), alpha=0.7)+
  #geom_segment(x=filter(red_v_blue_sum, vote=="Dem")$average_case_rate+250, xend=filter(red_v_blue_sum, vote=="Rep")$average_case_rate+500, y=5.37e-4, yend=4.3e-4)+
  theme(legend.position = "bottom")
  #scale_fill_manual(values = c("blue", "red"))+
  #labs(x="Governor Party Affiliation", y="Case Rate")+
  #theme_538()
p9
```


Cases Over Time (By State)
```{r}
 
xrange <-range(priority_ts_last30$date)
yrange <- range(priority_ts_last30$cases_delta_ma_per_hundred_thousand)

p5 <- ggplot(priority_ts_last30, aes(x = date, y = cases_delta_ma_per_hundred_thousand, color = state)) +
  geom_line(aes(group=state), size = 1) + 
  labs(y = "", title = "Daily New Cases per 100,000 Individuals", x = "Date") + 
  theme(legend.position = "bottom") + 
  annotate(geom = "text", x = xrange[1], y = yrange[2], label = paste(strwrap("Note: 7 Day Moving Average", 40), collapse = "\n"), hjust = 0, vjust = 1, size = 2)+ 
  scale_x_date(date_labels = "%b %d", date_breaks = "2 weeks")+
  facet_wrap("state", ncol = 1) +
  pq+jhu_caption
ggsave("11_states_cases.png", plot = p5, width = 8, height = 20, units = "in")
```

Daily Deaths per 10,000 People
```{r}
xrange <-range(priority_ts_last30$date)
yrange <- range(priority_ts_last30$deaths_delta_ma_per_hundred_thousand)

p6 <- ggplot(priority_ts_last30, aes(x = date, y = deaths_delta_ma_per_hundred_thousand, color = state)) +   geom_line(aes(group = state), size = 1)+ 
  #geom_smooth(aes(group = state), size = 1, se = FALSE, method = "loess", formula = 'y~x')+
  labs(y = "", title = "Daily New Deaths per 100,000 Individuals", x = "Date") + 
  theme(legend.position = "none") + 
  annotate(geom = "text", x = xrange[1], y = yrange[2], label = paste(strwrap("Note: 7 Day Moving Average", 40), collapse = "\n"), hjust = 0, vjust = 1, size = 2) + 
  facet_wrap("state", ncol = 2, shrink=FALSE) + 
  pq+jhu_caption
ggsave("11_states_deaths.png", plot = p6, width = 11, height = 8.5, units = "in")
```

Tree Map of Proportions
```{r}
tree_data <- red_v_blue %>% filter(date == max(date)) %>% top_n(25, deaths_per_hundred_thousand) %>% inner_join(uid)
tree_data
treemap(tree_data, index = "state", vSize = "Population", vColor="deaths_per_hundred_thousand", type = "dens", bg.labels = "transparent", fontcolor.labels=c("white"))

```

US National Statistics
```{r}
nation <- combined_ts_states %>% 
  arrange(date) %>% 
  group_by(date) %>% 
  filter(!(is.na(deaths))) %>% 
  summarise(population = us_uid$Population[5], cases = sum(cases), cases_it = cases / 1000, cases_delta = sum(cases_delta), cases_per_hundred_thousand = 100000 * cases / population, cases_perc = 100 * cases_delta / lag(cases), deaths = sum(deaths), deaths_it = deaths / 1000, deaths_delta = sum(deaths_delta), deaths_perc = as.double(100 * deaths_delta / lag(deaths)), deaths_per_hundred_thousand = 100000 * deaths / population) %>% 
  ungroup()

nation %<>% 
  mutate(lag_cases = as.double(lag(cases)), relative = cases_delta / lag_cases, cases_delta_ma = movingAverage(cases_delta),
  cases_perc = case_when(
    cases_perc == Inf ~ 100,
    TRUE ~ (100 * sum(cases_delta) / lag_cases)), cases_dir = (cases_delta_ma < lag(cases_delta_ma)),
  cases_perc_ma = movingAverage(cases_perc),
  lag_deaths = as.double(lag(deaths)), relative = deaths_delta / lag_deaths, deaths_delta_ma = movingAverage(deaths_delta),
  deaths_perc = case_when(
    deaths_perc == Inf ~ 100,
    TRUE ~ (100 * deaths_delta / lag_deaths)), deaths_dir = (deaths_delta_ma < lag(deaths_delta_ma)),
  deaths_perc_ma = movingAverage(deaths_perc)) %>% 
  ungroup()
nation[is.na(nation)] <- as.double(0)
nation[nation == Inf]<- as.double(100)
nation %<>%
  mutate(cases_dir = factor(nation$cases_dir, labels = c("Up", "Down")))
nation_last30 <- nation %>% 
  filter(date %in% sinceMarch16)
nation_today <- tail(nation_last30, 1) %>% select(-cases_it,-deaths_it,lag_cases,-relative,-cases_delta_ma,-cases_dir,-cases_perc_ma,-lag_deaths,-deaths_delta_ma,-deaths_dir,deaths_perc_ma)
nation_today
```
Break Up Dates into Waves
```{r}
us_cases_daily <- ts(diff(nation_last30$cases), end=c(2022, 7), frequency=365.25)
autoplot(us_cases_daily, series="Daily Cases")+
  autolayer(fitted(es(us_cases_daily)), series="Smoothed", size=1)+
  scale_y_continuous(labels=scales::label_comma())
```

New Cases
```{r message=FALSE, warning=FALSE}
xrange <-range(nation_last30$date)
yrange <- range(nation_last30$cases_delta)

nat_p1 <- nation_last30 %>% 
  ggplot() + 
    geom_line(aes(x = date, y = cases_delta), color = "blue", size = 1.2)+
    geom_smooth(aes(x=date, y=cases_delta), size=1, method="loess", se=FALSE, color="red")+
    geom_rect(nation_last30, x=nation_last30$date, y = nation_last30$cases_delta, mapping = aes(xmin = lag(date), xmax = date, fill = cases_dir), ymin = 0, ymax = Inf, alpha = 0.3) + 
    scale_color_manual(values = "blue")+
    scale_fill_manual(values = c("blue", "yellow"))+
    scale_y_continuous(breaks = breaks_extended(n=5), labels = scales::label_number_si(accuracy = 10))+
    labs(y = "", title = "Daily New Cases", x = "Days") +
    theme(legend.position = "right", 
          panel.grid.major.y=element_line(color="dark grey", size=0.1),
          panel.grid.minor.y=element_line(color="dark grey", size=0.1),
          axis.ticks=element_line(color="white")) +
    pq+
    #ylim(0,max(nation_last30$cases_delta))+
    annotate(geom = "text", x = xrange[2], y = 1000, label = paste("Note: 7 Day Moving Average", collapse = "\n"), hjust = 1, vjust = 0, size = 4)+jhu_caption+
  #First Wave Marker
  geom_vline(xintercept=mdy("03-16-20"),color = "red", size = 1.2) + 
  #Second Wave Marker
  geom_vline(xintercept=mdy("06-11-20"),color = "green", size = 1.2)+
  #Third Wave Marker
  geom_vline(xintercept=mdy("09-12-20"),color = "purple", size = 1.2)

nat_p1
```
```{r}
us_cases_weekly <- nation_last30 %>% 
  mutate(week = week(date), year=year(date)) %>% 
  arrange(date) %>% 
  group_by(year, week) %>% 
  summarize(avg_cases = mean(diff(cases))) %>% 
  ungroup() %>% 
  arrange(year, week) %>% 
  filter(!is.na(avg_cases))


us_cases_nat <- ts(us_cases_weekly$avg_cases, start=c(2020, 11), frequency = 52)

us_cases_chopped <- window(us_cases_nat, c(2021,51), c(2022,2))
us_cases_chopped
# model <- tbats(us_cases_nat)
```

```{r}
us_cases_mod <- tslm(us_cases_chopped ~ trend+season, biasadj = T)
us_cases_spf <- splinef(us_cases_chopped, method="mle", h=5)
us_cases_rwf <- rwf(us_cases_chopped, lambda=0, drift=T)
checkresiduals(resid(us_cases_mod))
# autoplot(us_cases_chopped)+autolayer(fitted(us_cases_spf))
# autoplot(diff(us_cases_nat))
autoplot(us_cases_chopped)+
  autolayer(forecast(us_cases_rwf, h=5), series="Moderate", size=1)+
  autolayer(forecast::forecast(us_cases_mod, h=5), size=1, series="Optimistic")+
  autolayer(us_cases_spf, series="Fuck", size=1)
```

```{r}
autoplot(us_cases_chopped)+scale_y_continuous(labels=scales::label_comma())+autolayer(window(us_cases_daily, c(2021, 360)))
```

```{r}
scale_y_continuous(labels=scales::label_comma())
```


```{r}
ggseasonplot(us_cases_nat, year.labels=T, year.labels.left=T, labelgap=.04) + ylab('Cases') + scale_y_continuous(labels=scales::comma) + theme(axis.text.x = element_text(angle=45))
```


Percent Change in Deaths (5 Day Moving Average)
```{r warning=FALSE}
xrange <-range(nation_last30$date)
yrange <- range(nation_last30$deaths_delta_ma)

nat_p4 <- nation_last30 %>% ggplot() + 
    geom_rect(nation_last30, x=nation_last30$date, y = nation_last30$deaths_delta_ma, mapping = aes(xmin = lag(date), xmax = date, fill = deaths_dir), ymin = 0, ymax = Inf, alpha = 0.3) + 
    geom_line(aes(x = date, y = deaths_delta_ma), size = 1.2, color="red") +
    scale_fill_manual(values = c("red", "green"))+
    scale_color_manual(values = red.fill.5)+
    scale_y_continuous(breaks = breaks_extended(n=5), labels = scales::label_number(accuracy = 1))+
    labs(y = "", title = "Daily Deaths", x = "Date") +
    theme(legend.position = "none", 
          panel.grid.major.y=element_line(color="dark grey", size=0.1),
          panel.grid.minor.y=element_line(color="dark grey", size=0.1),
          axis.ticks=element_line(color="white")) +
    pq + 
    #ylim(0,max(nation_last30$deaths_delta_ma))+
    annotate(geom = "text", x = xrange[2], y = yrange[2], label = paste("Note: 7 Day Moving Average", collapse = "\n"), hjust = 1, vjust = 0, size = 4)+jhu_caption
ggplotly(nat_p4)

```

Total Cases (in millions)
```{r}
xmax <- max(nation_last30)

nat_p2 <- nation_last30 %>% bar_chart_ts(nation_last30$cases, custom.fill = blue.fill.5, lab.title = "Total Cases")+
  jhu_caption+geom_hline(yintercept=max(nation_last30$cases), color="red")+
  theme(legend.position = "none", 
          panel.grid.major.y=element_line(color="dark grey", size=0.1),
          panel.grid.minor.y=element_line(color="dark grey", size=0.1),
          axis.ticks=element_line(color="white")) +
  scale_y_continuous(breaks = breaks_extended(n=5), labels = scales::label_number_si(accuracy = 1))#+geom_smooth(aes(y=cases, x=date), method="es", se=TRUE)
ggplotly(nat_p2)
```

Total Cases (Per 100,000  People)
```{r}
#model.p3 <- drm(nation_last30, formula = nation_last30$cases_per_hundred_thousand ~ nation_last30$date)
#summary(model.p3)
#model.p3$coefficients
nat_p3 <- nation_last30 %>% bar_chart_ts(nation_last30$cases_per_hundred_thousand, custom.fill = blue.fill.5, lab.title = "Total Cases (Per 100,000 People)")+ scale_y_continuous(breaks = breaks_extended(n=5), labels = scales::label_number_si(accuracy = 0.5))+
  theme(legend.position = "none", 
          panel.grid.major.y=element_line(color="dark grey", size=0.1),
          panel.grid.minor.y=element_line(color="dark grey", size=0.1),
          axis.ticks=element_line(color="white"))
    # + geom_smooth(method = "lm", se = FALSE)+jhu_caption
ggplotly(nat_p3)
```

Deaths Total
```{r}
nat_p5 <- nation_last30 %>% bar_chart_ts(nation_last30$deaths, custom.fill = red.fill.5, lab.title = "Cumulative Deaths")+jhu_caption+scale_y_continuous(breaks = breaks_extended(n=5), labels = scales::label_number_si(accuracy = 10))+
  theme(legend.position = "none", 
          panel.grid.major.y=element_line(color="dark grey", size=0.1),
          panel.grid.minor.y=element_line(color="dark grey", size=0.1),
          axis.ticks=element_line(color="white"))
ggplotly(nat_p5+geom_hline(yintercept=max(nation_last30$deaths), color="red"))
```

Deaths (Per 100,000 People)
```{r}
nat_p6 <- nation_last30 %>% bar_chart_ts(nation_last30$deaths_per_hundred_thousand, custom.fill = red.fill.5, lab.title = "Cumulative Deaths (Per 100,000 People)")+jhu_caption+theme(legend.position = "none", 
          panel.grid.major.y=element_line(color="dark grey", size=0.1),
          panel.grid.minor.y=element_line(color="dark grey", size=0.1),
          axis.ticks=element_line(color="white"))
ggplotly(nat_p6)
```
Mortality Rate
```{r}
mortality_rate <- (nation$deaths-lag(nation$deaths, 7)) / (lag(nation$cases, 7) - lag(nation$cases, 14))
mortality_rate[259]
```

```{r}
umap <- plot_usmap(region="states", data=filter(cases_ts_states, date==yd), values="cases_delta_per_hundred_thousand", include=.south_region)+
  labs(title="Infection Rate Per Hundred Thousand")+
  scale_fill_gradient(low="light yellow", high="dark red")
ggplotly(umap)
```